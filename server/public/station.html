<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="http://localhost:8080/public/" target="_parent" />
    <link rel="stylesheet" href="style/station.css" />
    <link rel="shortcut icon" href="img/logo-web.png" />
    <title>TB NET - Station</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <div class="header-table">
      <h1 id="station_name"></h1>
      <div class="button-logout">
        <button class="custom-button-fill" id="logoutButton">
          <span class="button-fill-text">Logout</span>
        </button>
      </div>
    </div>
    <p id="server_time"></p>
    <table id="customers">
      <tr>
        <th>Thông số</th>
        <th id="value000">Giá trị</th>
      </tr>
      <tr>
        <td>Điện áp Grid1</td>
        <td id="value001"></td>
      </tr>
      <tr>
        <td>Điện áp Grid2</td>
        <td id="value002"></td>
      </tr>
      <tr>
        <td>Điện áp Grid3</td>
        <td id="value003"></td>
      </tr>
      <tr>
        <td>Điện áp Gen1</td>
        <td id="value004"></td>
      </tr>
      <tr>
        <td>Điện áp Gen2</td>
        <td id="value005"></td>
      </tr>
    </table>
    <div class="div">
      <h1>Current Measurement Control</h1>
      <input
        type="checkbox"
        id="switch"
        class="checkbox"
        onclick="changeStatus();"
      />
      <label for="switch" class="toggle"> </label>
      <p id="status" style="font-size: 30"></p>
    </div>
    <script>
      let socket = io("http://localhost:8080");
      var station_id = localStorage.getItem("station_id");
      let el;
      let status_currentcontrol = 0;

      //Socket server to client
      socket.on("time", (timeString) => {
        let el = document.getElementById("server_time");
        el.innerHTML = "Server time " + timeString;
      });
      socket.on("data_station" + station_id, (newValue) => {
        handleData(newValue);
      });

      //Get data for the first load
      getData = async () => {
        axios
          .get("http://localhost:8080/stations/" + station_id, {
            headers: { "auth-token": localStorage.getItem("auth-token") },
          })
          .then((response) => {
            if (response.data === false) {
              window.location.href = "login.html";
            }
            let lastValue = response.data.lastValue;
            let status_currentcontrol = response.data.status_currentcontrol;
            let station_name = document.getElementById("station_name");
            station_name.innerHTML = localStorage.getItem("station_name");
            handleStatusControl(status_currentcontrol);
            handleData(lastValue);
          })
          .catch((error) => {
            if (error) {
              console.log(error);
            } else {
              console.log(error.message);
            }
          });
      };
      getData();

      //Handle Data
      handleData = (values) => {
        let el001 = document.getElementById("value001");
        el001.innerHTML = values.value001;
        let el002 = document.getElementById("value002");
        el002.innerHTML = values.value002;
        let el003 = document.getElementById("value003");
        el003.innerHTML = values.value003;
        let el004 = document.getElementById("value004");
        el004.innerHTML = values.value004;
        let el005 = document.getElementById("value005");
        el005.innerHTML = values.value005;
      };

      //Hadle status control
      handleStatusControl = (statusControl) => {
        const checkbox = document.getElementById("switch");
        const status = document.getElementById("status");
        if (statusControl == 1) {
          status_currentcontrol = 1;
          checkbox.checked = true;
          status.innerText = "ON";
        } else if (statusControl == 0) {
          status_currentcontrol = 0;
          checkbox.checked = false;
          status.innerText = "OFF";
        }
      };

      //Change status current control
      changeStatus = async () => {
        const status = document.getElementById("status");
        if (status_currentcontrol == 1) {
          status_currentcontrol = 0;
          status.innerText = "OFF";
        } else {
          status_currentcontrol = 1;
          status.innerText = "ON";
        }
        var data = {
          station_id,
          status_currentcontrol,
        };
        console.log(data);
        socket.emit("CurrentControl", data);
      };

      //logout
      var logoutButton = document.getElementById("logoutButton");
      logoutButton.addEventListener("click", () => {
        localStorage.removeItem("auth-token");
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
