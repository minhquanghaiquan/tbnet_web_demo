<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="http://178.128.113.184:8081/public/" target="_parent" />
    <link rel="stylesheet" href="style/station.css" />
    <link rel="shortcut icon" href="img/logo-web.png" />
    <title>TB NET - Station</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <div class="header-table">
      <h1 id="device_id"></h1>
      <div class="button-logout">
        <button class="custom-button-fill" id="logoutButton">
          <span class="button-fill-text">Logout</span>
        </button>
      </div>
    </div>
    <div class="header-button-connect">
      <p id="server_time"></p>
      <div class="button-connect">
        <button class="custom-button-connect-fill">
          <span class="button-connect-fill-text">Device Connected</span>
        </button>
      </div>
    </div>

    <div class="category">
      <a href="#" class="item">
        <span class="title">Điện áp gen 0 </span>
        <span class="title" id="value0"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 1</span>
        <span class="title" id="value1"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 2</span>
        <span class="title" id="value2"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 3</span>
        <span class="title" id="value3"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 4</span>
        <span class="title" id="value4"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 5</span>
        <span class="title" id="value5"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 6</span>
        <span class="title" id="value6"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 7</span>
        <span class="title" id="value7"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 8</span>
        <span class="title" id="value8"></span>
      </a>

      <a href="#" class="item">
        <span class="title">Điện áp gen 9</span>
        <span class="title" id="value9"></span>
      </a>
      <a href="#" class="item">
        <span class="title">Điện áp gen 10</span>
        <span class="title" id="value10"></span>
      </a>
    </div>

    <h1 id="device_id">SETTING</h1>

    <div class="div-setting category">
      <a href="#" class="item">
        <span class="title">Điều khiển 1 </span>
        <div class="item-setting">
          <input
            type="checkbox"
            id="switch"
            class="checkbox"
            onclick="changeStatus_1();"
          />
          <label for="switch" class="toggle"> </label>
          <p id="status" style="font-size: 30"></p>
        </div>
      </a>

      <a href="#" class="item">
        <span class="title">Điều khiển 2 </span>
        <div class="item-setting">
          <input
            type="checkbox"
            id="switch"
            class="checkbox"
            onclick="changeStatus_2();"
          />
          <label for="switch" class="toggle"> </label>
          <p id="status" style="font-size: 30"></p>
        </div>
      </a>

      <a href="#" class="item">
        <span class="title">Điều khiển 3 </span>
        <div class="item-setting">
          <input
            type="checkbox"
            id="switch"
            class="checkbox"
            onclick="changeStatus_3();"
          />
          <label for="switch" class="toggle"> </label>
          <p id="status" style="font-size: 30"></p>
        </div>
      </a>

      <a href="#" class="item">
        <span class="title">Điều khiển 4 </span>
        <div class="item-setting">
          <input
            type="checkbox"
            id="switch"
            class="checkbox"
            onclick="changeStatus_4();"
          />
          <label for="switch" class="toggle"> </label>
          <p id="status" style="font-size: 30"></p>
        </div>
      </a>

      <a href="#" class="item">
        <span class="title">Điều khiển 5 </span>
        <div class="item-setting">
          <input
            type="checkbox"
            id="switch"
            class="checkbox"
            onclick="changeStatus_5();"
          />
          <label for="switch" class="toggle"> </label>
          <p id="status" style="font-size: 30"></p>
        </div>
      </a>
    </div>
    <script>
      let socket = io("http://178.128.113.184:8081");
      var device_id = localStorage.getItem("device_id");
      let status_currentcontrol = 0;

      //Socket server to client
      socket.on("time", (timeString) => {
        let el = document.getElementById("server_time");
        el.innerHTML = "Server time " + timeString;
      });
      socket.on(device_id + "/control", (newValue) => {
        handleData(newValue.payload);
      });

      //Get data for the first load
      getData = async () => {
        axios
          .get("http://178.128.113.184:8081/stations/" + device_id, {
            headers: { "auth-token": localStorage.getItem("auth-token") },
          })
          .then((response) => {
            if (response.data === false) {
              window.location.href = "login.html";
            }
            let lastValue = response.data.lastValue;
            let status_currentcontrol = response.data.status_currentcontrol;
            let device_id = document.getElementById("device_id");
            device_id.innerHTML = localStorage.getItem("device_id");
            handleStatusControl(status_currentcontrol);
            handleData(lastValue);
          })
          .catch((error) => {
            if (error) {
              console.log(error);
            } else {
              console.log(error.message);
            }
          });
      };
      getData();

      //Handle Data
      handleData = (values) => {
        console.log(values);
        for (var i = 0; i < 21; i++) {
          let el = document.getElementById("value" + i);
          var key = "s" + i;
          if (!values[key]) {
            el.innerHTML = 0;
          } else {
            el.innerHTML = values[key];
          }
        }
      };

      //Hadle status control
      handleStatusControl = (statusControl) => {
        const checkbox = document.getElementById("switch");
        const status = document.getElementById("status");
        if (statusControl == 1) {
          status_currentcontrol = 1;
          checkbox.checked = true;
          status.innerText = "ON";
        } else if (statusControl == 0) {
          status_currentcontrol = 0;
          checkbox.checked = false;
          status.innerText = "OFF";
        }
      };

      //Change status current control
      changeStatus_1 = async () => {
        const status = document.getElementById("status");
        if (status_currentcontrol == 1) {
          status_currentcontrol = 0;
          status.innerText = "OFF";
        } else {
          status_currentcontrol = 1;
          status.innerText = "ON";
        }
        var data = {
          device_id,
          status_currentcontrol,
        };
        console.log(data);
        socket.emit("CurrentControl", data);
      };

      //logout
      var logoutButton = document.getElementById("logoutButton");
      logoutButton.addEventListener("click", () => {
        localStorage.removeItem("auth-token");
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
